---
title: "All GDQs"
date: "Updated at `r format(Sys.time(), '%F %T %Z')`"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
source("00_document_settings.R")

donations <- readRDS("data/all_donations.rds")
runs <- readRDS("data/all_runs_gdqvods.rds")

donations %>%
  group_by(event) %>%
  summarize(
    total = sum(amount),
    avg = mean(amount)
  ) %>%
  mutate(
    year = as.numeric(str_extract(event, "\\d+")),
    gdq = str_extract(event, "[A-Z]+")
  ) %>%
  arrange(year) %>%
  mutate(cumtot = cumsum(total)) -> gdq_donation_totals
```

Since I discovered that the [GDQ donations are public, tabular und scrapeable](https://gamesdonequick.com/tracker/donations/), I couldn't resist cobbling together a script to scrape all the data.  
Here are some results.

# Donations 

First up we look at the donation totals for each event.  
Note that as of now I only collected data from [AS]GDQs since 2011, the other events are not included (yet?).

```{r donations_by_event}
gdq_donation_totals %>%
  ggplot(aes(x = year, y = total, fill = gdq)) +
  geom_col(position = position_dodge(), alpha = .75) +
  scale_x_year() +
  scale_y_currency(
    breaks = seq(0, 3e6, 5e5),
    minor_breaks = seq(0, 3e6, 1e5)
  ) +
  scale_colorfill_gdq() +
  labs(
    title = "Games Done Quick: Donation Totals",
    subtitle = "Donation totals as per the official tracker page"
  )
```

## Relative change event to event

```{r donations_relative_change}
gdq_donation_totals %>%
  group_by(gdq) %>%
  mutate(gain = total - lag(total)) %>%
  ggplot(aes(x = year, y = gain, fill = gdq)) +
  geom_col(position = position_dodge(), alpha = .75) +
  scale_x_year() +
  scale_y_currency(
    breaks = seq(-2e6, 2e6, 2e5),
    minor_breaks = seq(-2e6, 2e6, 5e4)
  ) +
  facet_wrap(~gdq) +
  scale_colorfill_gdq(guide = FALSE) +
  labs(
    title = "Games Done Quick: Donation Totals",
    subtitle = "Per-GDQ donation totals: Difference from previous event"
  )
```


## Cumulative total

```{r donations_cumulative_by_event}
gdq_donation_totals %>%
  ggplot(aes(x = year, y = cumtot, fill = gdq)) +
  geom_col(position = position_dodge(), alpha = .75) +
  scale_x_year() +
  scale_y_currency(
    breaks = seq(0, 3e7, 5e6),
    minor_breaks = seq(0, 3e7, 1e6)
  ) +
  scale_colorfill_gdq() +
  labs(
    title = "Games Done Quick: Donation Totals",
    subtitle = "Cumulative donation totals as per the official tracker page"
  )
```

## Prediction

```{r donations_cumulative_model}
gdq_donation_totals %>%
  mutate(year = ifelse(gdq == "SGDQ", year + .5, year)) %>%
  ggplot(aes(x = year, y = cumtot, color = gdq, fill = gdq)) +
  geom_smooth(aes(group = 1), method = lm, formula = y ~ poly(x, 2),
              se = FALSE, color = "black", linetype = "dashed", size = .75) +
  geom_point(size = 2.5, key_glyph = "rect", shape = 21, color = "white") +
  scale_x_year() +
  scale_y_currency() +
  scale_colorfill_gdq() +
  labs(
    title = "Games Done Quick: Donation Totals",
    subtitle = "Cumulative donation totals: Quadratic model"
  )


mod <- lm(cumtot ~ year + I(year^2), # poly(year, 2),
          data = gdq_donation_totals %>%
            mutate(year = ifelse(gdq == "SGDQ", year + .5, year),
                   cumtot = cumtot/1e6)
)

model_equations <- function(mod) {
  coefs <- round(coef(mod), 2)

  glue::glue("\\widehat{\\text{Total}} = (coefs[[1]]) + (coefs[[2]]) \\cdot \\text{Year} + (coefs[[3]]) \\cdot \\text{Year}^2", .open = "(", .close = ")")
}
```

The model equation:

$$`r model_equations(mod)`$$

Let's make some naive predictions for the upcoming years:

```{r donations_cumulative_predictions}
current_year <- year(today())

pred_df <- tibble(year = seq(current_year, current_year + 5, .5))
predicted <- as_tibble(predict(mod, newdata = pred_df, interval = "pred")) %>%
  mutate_all(round, 2) %>%
  mutate(
    fit = paste0("$", fit),
    Year = pred_df$year,
    ci = glue::glue("({lwr}, {upr})"),
    GDQ = ifelse(str_detect(as.character(Year), ".5$"), "SGDQ", "AGDQ"),
    Year = floor(Year)
  ) %>%
  select(GDQ, Year, fit, ci)

predicted %>%
  setNames(c("GDQ", "Year", "Predicted Total (Millions)", "CI (95% Prediction)")) %>%
  kable(align = c("c", "c", "c", "c")) %>%
  kable_styling(
    bootstrap_options = c("striped"),
    position = "center"
  )
```

# Runs

```{r runs_lengths_boxplot}
runs %>%
  mutate(
    year = fct_rev(year),
    gdq = fct_rev(gdq)
  ) %>%
  ggplot(aes(x = year, y = time, color = gdq, fill = gdq)) +
  geom_boxplot(alpha = .5) +
  stat_summary(
    fun.y = mean, geom = "point", position = position_dodge2(width = .75),
    shape = 21, color = "black", stroke = .5, key_glyph = "rect"
  ) +
  coord_flip() +
  scale_y_time(breaks = seq(0, 10, 1) * 60^2) +
  scale_colorfill_gdq(guide = guide_legend(reverse = TRUE)) +
  #ggforce::facet_zoom(y = time <= hms::hms(hours = 3)) +
  labs(
    title = p_title_r,
    subtitle = "Run durations by event",
    x = "", y = "H:M:S"
  ) +
  theme_ipsum_fsc(grid = "Xx") +
  theme(
    legend.position = c(.6, 1.08),
    legend.direction = "horizontal",
    panel.grid.major = element_line(colour = "#aaaaaa")
  )
```

Maybe a zoomed in version is easier to digest.

```{r run_lengths_boxplot_sub3}
runs %>%
  filter(time <= hms::hms(hours = 2)) %>%
  mutate(
    year = fct_rev(year),
    gdq = fct_rev(gdq)
  ) %>%
  ggplot(aes(x = year, y = time, color = gdq, fill = gdq)) +
  geom_boxplot(alpha = .5) +
  stat_summary(
    fun.y = mean, geom = "point", position = position_dodge2(width = .75),
    shape = 21, color = "black", stroke = .5, key_glyph = "rect"
  ) +
  coord_flip() +
  scale_y_time(
    breaks = seq(0, 10, .5) * 60^2,
    minor_breaks = seq(0, 10, .25) * 60^2
  ) +
  scale_colorfill_gdq(guide = guide_legend(reverse = TRUE)) +
  labs(
    title = p_title_r,
    subtitle = "Run durations by event: Sub 2 hour runs only",
    x = "", y = "H:M:S"
  ) +
  theme_ipsum_fsc(grid = "Xx") +
  theme(
    legend.position = c(.6, 1.08),
    legend.direction = "horizontal",
    panel.grid.major = element_line(colour = "#aaaaaa")
  )
```

Or maybe a histogram.

```{r run_lengths_histogram}
runs %>%
  ggplot(aes(x = time, color = gdq, fill = gdq)) +
  geom_histogram(
    binwidth = .5 * 60^2, position = "dodge", alpha = .5
  ) +
  facet_wrap(~gdq) +
  scale_colorfill_gdq(guide = FALSE) +
  labs(
    title = p_title_r,
    subtitle = "Number of runs in 30min intervals across all events",
    y = "# of runs"
  )
```

