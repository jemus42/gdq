---
title: "SGDQ 2018"
date: "`r format(Sys.time(), '%F %T %Z')`"
output: html_document
---

```{r setup, include=FALSE}
source("helpers.R")
opts_chunk$set(fig.path = "plots/sgdq2018_")
p_title <- "Summer Games Done Quick 2018: Donation Breakdown"

gdq_start <- ymd_hms("2018-06-24 00:00:00")
gdq_end   <- ymd_hms("2018-07-02 00:00:00")

sgdq <- readRDS("data/sgdq2018.rds") %>%
  filter(between(time, gdq_start, gdq_end)) %>%
  arrange(time) %>%
  mutate(day_num = fct_inorder(as.character(day_num), ordered = TRUE))
```

Donation timeline:

```{r timeline}
sgdq %>%
  ggplot(data = ., aes(x = time, y = cumsum(amount))) +
  geom_line(size = 2) +
  scale_x_datetime(date_breaks = "1 day",
                   date_labels = "%a (%d.)",
                   date_minor_breaks = "6 hours") +
  scale_y_continuous(breaks = seq(0, 3e6, 25e4),
                     minor_breaks = seq(0, 3e6, 1e5),
                     labels = scales::dollar,
                     sec.axis = sec_axis(~.*0.85,
                                         labels = euro_scale,
                                         breaks = seq(0, 3e6, 25e4))) +
  labs(title = p_title, caption = p_caption,
       subtitle = "Cumulative donations over the course of the event, all times in UTC.",
       x = "Time", y = "Amount Total")
```

Donation breakdown:

```{r donation_bysize}
sgdq %>%
  filter(name != "Twitch Subscriber Revenue") %>%
  group_by(amount_c) %>%
  summarize(n = n(),
            total = sum(amount)) %>%
  mutate(label = paste0("n = ", n, " â€“ total: ", scales::dollar(total))) %>%
  ggplot(aes(x = amount_c, y = n)) +
  geom_col() +
  coord_flip() +
  geom_label(aes(label = label), hjust = 0, nudge_y = 100) +
  expand_limits(y = 15e3) +
  labs(title = p_title, caption = p_caption,
       subtitle = "Donation amounts by bin, each bin excludes the previous lower bin.\nExcluding donations labelled 'Twitch Subscriber Revenue'",
       x = "Donation Amount", y = "# of Donations")
```

## Donations per Day

Donation total by day, excluding the Twitch subscription revenue as well, as it would skew the amounts on the first and last day respectively.

```{r donations_total_by_day}
sgdq %>%
  filter(name != "Twitch Subscriber Revenue") %>%
  group_by(day_num) %>%
  summarize(n = n(), total = sum(amount)) %>%
  ggplot(aes(x = day_num, y = total, fill = day_num)) +
  geom_col(color = "black", alpha = .75) +
  scale_y_continuous(breaks = seq(0, 1e6, 1e5),
                     minor_breaks = seq(0, 1e6, 2.5e4),
                     labels = scales::dollar,
                     sec.axis = sec_axis(~.*0.85,
                                         labels = euro_scale,
                                         breaks = derive())) +
  scale_fill_brewer(palette = "Dark2", guide = F) +
  labs(title = p_title, caption = p_caption,
       subtitle = "Donation totals by day, excluding the Twitch subscribtion revenue.",
       x = "", y = "Donation Total")
```

Individual donations by day both as points and a boxplot.

```{r donations_boxpoints_by_day}
sgdq %>%
  filter(name != "Twitch Subscriber Revenue") %>%
  ggplot(aes(day_num, amount, color = day)) +
  geom_quasirandom() +
  geom_boxplot(alpha = .75) +
  scale_y_log10(breaks = amount_breaks, labels = scales::dollar,
                sec.axis = euro_axis()) +
  scale_color_brewer(palette = "Dark2", guide = F) +
  labs(title = p_title, caption = p_caption,
       subtitle = "Donations by day, excluding the Twitch subscribtion revenue.",
       x = "Event Day", y = "Amount (log10)")
```

The grouping by day is mostly done because a plain, all-week scatterplot looks like this:

```{r donations_points_by_day}
sgdq %>%
  ggplot(aes(time, amount, color = day)) +
  geom_point(alpha = .5) +
  scale_x_datetime(date_breaks = "1 day", date_labels = "%b %d",
                   date_minor_breaks = "6 hours") +
  scale_y_log10(breaks = amount_breaks, labels = scales::dollar,
                sec.axis = euro_axis())) +
  scale_color_brewer(palette = "Dark2", guide = F) +
  labs(title = p_title, caption = p_caption,
       x = "Time", y = "Amount (log10)")
```

However, looking at means and 95% confidence intervals, we get this:

```{r donations_meanci_by_day}
sgdq %>%
  filter(name != "Twitch Subscriber Revenue") %>%
  ggplot(aes(x = day_num, y = amount, color = day_num, fill = day_num)) +
  stat_summary(fun.data = mean_cl_normal, geom = "errorbar", 
               size = 1.5, width = .5) +
  stat_summary(fun.y = mean, geom = "point", shape = 21, color = "black",
               size = 2.5) +
  scale_y_continuous(breaks = pretty_breaks(), 
                     labels = dollar, 
                     sec.axis = euro_axis(breaks = pretty_breaks())) +
  scale_color_brewer(palette = "Dark2", guide = F) +
  scale_fill_brewer(palette = "Dark2", guide = F) +
  labs(title = p_title, caption = p_caption,
       subtitle = "Average donation amount per day with 95% normal confidence interval.\nTwitch subscription revenue not included.",
       x = "Day", y = "Amount (mean & 96% CI)")

```

